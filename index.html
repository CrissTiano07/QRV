<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Painel Operacional ‚Äî Tr√¢nsito Fortaleza</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root{
  --fundo:#e9eef5;
  --sombra:#c5cad3;
  --luz:#ffffff;
  --laranja:#f97316;
  --vermelho:#dc2626;
  --texto:#0f172a;
  --verde:#16a34a;
  --azul:#2563eb;
  --amarelo:#facc15;
  --cinza:#475569;
  --roxo:#9333ea;
}

/* BASE */
html,body{
  margin:0;height:100%;width:100%;
  background:var(--fundo);
  font-family:'Inter',system-ui,sans-serif;
  color:var(--texto);
  overflow:hidden;
  -webkit-tap-highlight-color:transparent;
  transition:background .3s ease,color .3s ease;
  touch-action:pan-y;
}
.view{
  position:absolute;top:0;left:0;width:100%;height:100%;
  transition:transform .5s cubic-bezier(.25,.8,.25,1);
  background:var(--fundo);
  overflow:hidden;
}
.view-scrollable{
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.hidden-right{transform:translateX(100%);}
.hidden-left{transform:translateX(-100%);}
.active{transform:translateX(0);}

/* CABE√áALHO */
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;
}
h1{
  font-size:clamp(18px,4vw,22px);
  color:var(--laranja);
  letter-spacing:0.4px;
  font-weight:700;
  text-shadow:1px 1px 2px var(--luz);
  margin:0;
}
.theme-toggle{
  background:none;border:none;color:var(--texto);
  width:32px;height:32px;display:flex;align-items:center;justify-content:center;
}
.theme-toggle svg{width:22px;height:22px;}

/* GRADE DE BOT√ïES */
.painel{
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:repeat(2,1fr);
  gap:14px;
  width:70vw; 
  max-width:380px;
  height:55vh;
  margin:2vh auto;
}
.btn{
  border:none;border-radius:20px;
  background:var(--fundo);
  box-shadow:8px 8px 16px var(--sombra), -8px -8px 16px var(--luz);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:15px;font-weight:700;color:var(--texto);
  transition:all .15s ease-in-out;
}
.btn:active{
  box-shadow:inset 8px 8px 16px var(--sombra),
              inset -8px -8px 16px var(--luz);
  transform:scale(.97);
}
.btn svg{width:28px;height:28px;margin-bottom:6px;}
.qrv svg{stroke:var(--laranja);}
.foto svg{stroke:var(--azul);}
.apoio svg{stroke:var(--verde);}
.revezamento svg{stroke:var(--roxo);}

/* BARRA INFERIOR */
.bottom-bar{
  position:absolute;bottom:0;left:0;width:100%;
  display:flex;justify-content:space-evenly;align-items:center;
  padding:16px 0;background:var(--fundo);
  box-shadow:0 -6px 16px rgba(0,0,0,0.05);
}
.bottom-btn{
  width:40%;max-width:150px;height:58px;
  border-radius:40px;font-weight:700;font-size:15px;
  display:flex;align-items:center;justify-content:center;gap:6px;
  transition:all .15s ease-in-out;
  box-shadow:8px 8px 16px var(--sombra), -8px -8px 16px var(--luz);
  background:var(--fundo);
}
.bottom-btn svg{width:20px;height:20px;}
.bottom-btn:active{
  box-shadow:inset 8px 8px 16px var(--sombra), inset -8px -8px 16px var(--luz);
  transform:scale(.96);
}
.btn-emergencia{color:var(--vermelho);}
.btn-central{color:var(--laranja);}

/* FORMUL√ÅRIOS */
.card{
  background:var(--fundo);
  border-radius:20px;
  box-shadow:8px 8px 16px var(--sombra), -8px -8px 16px var(--luz);
  padding:24px;
  width:86%;
  max-width:420px;
  margin:auto;
}

label{
  display:block;
  font-size:13px;
  font-weight:700;
  letter-spacing:0.5px;
  margin-top:16px;
  margin-bottom:8px;
  color:var(--laranja);
  text-transform:uppercase;
}

input,select{
  width:100%;
  border:none;
  outline:none;
  background:var(--fundo);
  box-shadow:inset 5px 5px 10px var(--sombra),
             inset -5px -5px 10px var(--luz);
  border-radius:14px;
  padding:16px 18px;
  font-size:17px;
  font-weight:600;
  color:var(--texto);
  text-transform:uppercase;
  transition:box-shadow .2s ease;
}

input:focus,select:focus{
  box-shadow:inset 3px 3px 8px var(--sombra), 
             inset -3px -3px 8px var(--luz),
             0 0 0 3px rgba(249,115,22,0.15);
}

input::placeholder{
  color:var(--cinza);
  opacity:0.6;
  font-weight:500;
}

textarea{
  width:100%;
  border:none;
  outline:none;
  background:var(--fundo);
  box-shadow:inset 5px 5px 10px var(--sombra),
             inset -5px -5px 10px var(--luz);
  border-radius:14px;
  padding:16px 18px;
  font-size:17px;
  font-weight:600;
  color:var(--texto);
  text-transform:uppercase;
  margin-top:6px;
  min-height:80px;
  resize:vertical;
}

.send-area{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:24px;
}

.primary-btn{
  background:linear-gradient(145deg, #ff8a47, #f97316);
  color:#fff;
  border:none;
  border-radius:14px;
  padding:14px 28px;
  font-size:16px;
  font-weight:700;
  box-shadow:6px 6px 12px #c5cad3, 
             -6px -6px 12px #fff,
             inset 0 1px 2px rgba(255,255,255,0.3);
  transition:all .12s ease-in-out;
}
.primary-btn:active{
  box-shadow:inset 6px 6px 12px #c5cad3, 
             inset -6px -6px 12px #fff;
  transform:scale(.98);
}

/* RATT - REVEZAMENTO APRIMORADO */
.ratt-config{
  display:grid;
  gap:12px;
  margin-bottom:20px;
}

.ratt-toggle-group{
  display:flex;
  gap:8px;
  justify-content:center;
}

.ratt-toggle-btn{
  flex:1;
  padding:12px;
  border:none;
  border-radius:12px;
  background:var(--fundo);
  box-shadow:inset 5px 5px 10px var(--sombra),
             inset -5px -5px 10px var(--luz);
  font-weight:600;
  font-size:14px;
  color:var(--texto);
  transition:all .2s;
}

.ratt-toggle-btn.active{
  background:linear-gradient(145deg, #a855f7, #9333ea);
  color:#fff;
  box-shadow:6px 6px 12px var(--sombra), 
             -6px -6px 12px var(--luz);
}

/* CRON√îMETRO CIRCULAR */
.ratt-circular-timer{
  position:relative;
  width:200px;
  height:200px;
  margin:20px auto;
}

.timer-circle{
  position:absolute;
  top:0;left:0;
  width:100%;
  height:100%;
  transform:rotate(-90deg);
}

.timer-bg{
  fill:none;
  stroke:var(--sombra);
  stroke-width:12;
}

.timer-progress{
  fill:none;
  stroke:var(--roxo);
  stroke-width:12;
  stroke-linecap:round;
  transition:stroke-dashoffset .3s ease;
}

.timer-center{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
}

.timer-display{
  font-size:32px;
  font-weight:700;
  color:var(--roxo);
  font-variant-numeric:tabular-nums;
}

.timer-label{
  font-size:12px;
  color:var(--cinza);
  font-weight:600;
  margin-top:4px;
}

/* PROGRESSO DO TURNO */
.turno-progress{
  background:var(--fundo);
  border-radius:12px;
  padding:16px;
  box-shadow:inset 5px 5px 10px var(--sombra),
             inset -5px -5px 10px var(--luz);
  margin-bottom:20px;
}

.turno-times{
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
  font-size:14px;
  font-weight:600;
  color:var(--texto);
}

.progress-bar{
  height:8px;
  background:var(--sombra);
  border-radius:4px;
  overflow:hidden;
}

.progress-fill{
  height:100%;
  background:linear-gradient(90deg, var(--roxo), var(--laranja));
  transition:width .3s ease;
  border-radius:4px;
}

/* CARDS DE OPERADORES */
.operators-grid{
  display:grid;
  gap:12px;
  margin-top:16px;
}

.operator-card{
  background:var(--fundo);
  border-radius:12px;
  padding:12px;
  box-shadow:6px 6px 12px var(--sombra), 
             -6px -6px 12px var(--luz);
  display:flex;
  align-items:center;
  gap:12px;
  transition:all .3s ease;
}

.operator-card.active{
  background:linear-gradient(135deg, #a855f7, #9333ea);
  color:#fff;
  box-shadow:8px 8px 16px var(--sombra), 
             -8px -8px 16px var(--luz);
}

.operator-icon{
  width:40px;
  height:40px;
  border-radius:50%;
  background:var(--fundo);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:16px;
  box-shadow:inset 3px 3px 6px var(--sombra),
             inset -3px -3px 6px var(--luz);
}

.operator-card.active .operator-icon{
  background:rgba(255,255,255,0.2);
  box-shadow:inset 2px 2px 4px rgba(0,0,0,0.2);
  color:#fff;
}

.operator-info{
  flex:1;
}

.operator-name{
  font-weight:700;
  font-size:15px;
}

.operator-status{
  font-size:12px;
  opacity:0.7;
  margin-top:2px;
}

.ratt-controls{
  display:flex;
  gap:10px;
  margin-top:20px;
}

.ratt-btn{
  flex:1;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:700;
  font-size:15px;
  box-shadow:6px 6px 12px var(--sombra), 
             -6px -6px 12px var(--luz);
  transition:all .15s;
}

.ratt-btn:active{
  box-shadow:inset 6px 6px 12px var(--sombra), 
             inset -6px -6px 12px var(--luz);
  transform:scale(.96);
}

.ratt-btn-primary{
  background:linear-gradient(145deg, #a855f7, #9333ea);
  color:#fff;
}

.ratt-btn-secondary{
  background:var(--fundo);
  color:var(--texto);
}

/* MODO ESCURO */
.dark{
  --fundo:#0e1624;
  --sombra:#060910;
  --luz:#1b2434;
  --texto:#e6eef8;
}
.dark .btn,.dark .bottom-btn,.dark .card{
  box-shadow:8px 8px 16px var(--sombra), -8px -8px 16px var(--luz);
}
.dark h1{color:#f97316;text-shadow:none;}
.dark .btn-emergencia{color:#ef4444;}
.dark .btn-central{color:#f97316;}
.dark .theme-toggle{color:#e6eef8;}
.dark label{color:#ff8a47;}
.dark input,.dark select,.dark textarea{
  box-shadow:inset 5px 5px 10px var(--sombra),
             inset -5px -5px 10px var(--luz);
}
.dark input:focus,.dark select:focus,.dark textarea:focus{
  box-shadow:inset 3px 3px 8px var(--sombra), 
             inset -3px -3px 8px var(--luz),
             0 0 0 3px rgba(249,115,22,0.2);
}
.dark .primary-btn{
  background:linear-gradient(145deg, #ff8a47, #f97316);
  box-shadow:6px 6px 12px #060910, 
             -6px -6px 12px #1b2434,
             inset 0 1px 2px rgba(255,138,71,0.2);
}
.dark .ratt-toggle-btn{
  box-shadow:inset 5px 5px 10px var(--sombra),
             inset -5px -5px 10px var(--luz);
}
.dark .ratt-toggle-btn.active{
  background:linear-gradient(145deg, #a855f7, #9333ea);
  box-shadow:6px 6px 12px var(--sombra), 
             -6px -6px 12px var(--luz);
}
.dark .timer-bg{
  stroke:var(--sombra);
}
.dark .operator-icon{
  box-shadow:inset 3px 3px 6px var(--sombra),
             inset -3px -3px 6px var(--luz);
}
.dark .operator-card{
  box-shadow:6px 6px 12px var(--sombra), 
             -6px -6px 12px var(--luz);
}
.dark .operator-card.active{
  box-shadow:8px 8px 16px var(--sombra), 
             -8px -8px 16px var(--luz);
}
</style>
</head>
<body>

<!-- MENU PRINCIPAL -->
<div id="menuView" class="view active">
  <header>
    <h1>Painel Operacional</h1>
    <button class="theme-toggle" id="themeToggle" title="Alternar tema"><i data-lucide="moon"></i></button>
  </header>

  <div class="painel">
    <button class="btn qrv" onclick="abrir('qrvView')"><i data-lucide="radio"></i>QRV/QRU/QTA</button>
    <button class="btn foto" onclick="abrir('fotoView')"><i data-lucide="camera"></i>QTH/FOTO</button>
    <button class="btn apoio" onclick="abrir('apoioView')"><i data-lucide="life-buoy"></i>APOIO</button>
    <button class="btn revezamento" onclick="abrir('rattView')"><i data-lucide="users"></i>REVEZAMENTO</button>
  </div>

  <div class="bottom-bar">
    <button class="bottom-btn btn-emergencia" id="emergenciaBtn"><i data-lucide="alert-triangle"></i>Emerg√™ncia</button>
    <button class="bottom-btn btn-central" onclick="ligarCentral()"><i data-lucide="phone"></i>Central</button>
  </div>
</div>

<!-- VIEW QRV -->
<div id="qrvView" class="view hidden-right">
  <header>
    <button onclick="voltar('qrvView')" class="theme-toggle"><i data-lucide="arrow-left"></i></button>
    <h1>QRV Operacional</h1>
    <button onclick="limparQRV()" class="theme-toggle" title="Limpar dados"><i data-lucide="trash-2"></i></button>
  </header>

  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:85%;">
    <form id="qrvForm" class="card" autocomplete="off">
      <label for="vt">Viatura (VT)</label>
      <input id="vt" type="text" inputmode="numeric" placeholder="Ex: 222" required>

      <label for="equipe">Equipe</label>
      <input id="equipe" type="text" placeholder="Condutor, Tripulante, Tripulante" required>

      <label for="qru">QRU</label>
      <input list="qruList" id="qru" placeholder="Selecione ou digite..." required>
      <datalist id="qruList">
        <option value="CONTROLE DE TR√ÅFEGO">
        <option value="APOIO OPERACIONAL">
        <option value="ACIDENTE">
        <option value="RETIRADA DE OBST√ÅCULO">
        <option value="DESLOCAMENTO">
        <option value="ABORDAGEM">
        <option value="PATRULHAMENTO">
        <option value="OUTROS">
      </datalist>

      <label for="qth">QTH</label>
      <input id="qth" type="text" placeholder="Ex: RUA 01 X RUA 02" required>

      <div class="send-area">
        <button type="button" class="primary-btn" onclick="enviarQRV()">Enviar</button>
      </div>
    </form>
  </div>
</div>

<!-- VIEW FOTO -->
<div id="fotoView" class="view view-scrollable hidden-right">
  <header>
    <button onclick="voltar('fotoView')" class="theme-toggle"><i data-lucide="arrow-left"></i></button>
    <h1>Registro Fotogr√°fico</h1>
    <div style="width:32px;"></div>
  </header>

  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:85%;padding:20px 0;">
    <div class="card">
      <label for="fotoVt">Viatura (VT)</label>
      <input id="fotoVt" type="text" readonly style="opacity:0.7;">

      <label for="fotoEquipe">Equipe</label>
      <input id="fotoEquipe" type="text" readonly style="opacity:0.7;">

      <label for="fotoQru">QRU</label>
      <input id="fotoQru" type="text" readonly style="opacity:0.7;">

      <label for="fotoQth">QTH</label>
      <input id="fotoQth" type="text" readonly style="opacity:0.7;">

      <div style="margin-top:24px;text-align:center;">
        <input type="file" id="inputFoto" accept="image/*" capture="environment" style="display:none;">
        <button type="button" class="primary-btn" onclick="tirarFoto()" style="width:100%;">
          Tirar Foto
        </button>
      </div>

      <div id="previewContainer" style="margin-top:20px;display:none;">
        <img id="previewFoto" style="width:100%;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
        <div style="display:flex;gap:10px;margin-top:16px;">
          <button type="button" class="primary-btn" onclick="enviarFoto()" style="flex:1;">Enviar</button>
          <button type="button" onclick="resetarFoto()" style="flex:1;background:var(--cinza);color:#fff;border:none;border-radius:14px;padding:14px;font-weight:700;box-shadow:6px 6px 12px var(--sombra),-6px -6px 12px var(--luz);">Nova Foto</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VIEW APOIO -->
<div id="apoioView" class="view hidden-right">
  <header>
    <button onclick="voltar('apoioView')" class="theme-toggle"><i data-lucide="arrow-left"></i></button>
    <h1>Apoio Operacional</h1>
    <div style="width:32px;"></div>
  </header>

  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:85%;">
    <form id="apoioForm" class="card" autocomplete="off">
      <label for="apoioVt">Viatura (VT)</label>
      <input id="apoioVt" type="text" readonly style="opacity:0.7;">

      <label for="apoioCondutor">Condutor</label>
      <input id="apoioCondutor" type="text" readonly style="opacity:0.7;">

      <label for="apoioQth">QTH</label>
      <input id="apoioQth" type="text" readonly style="opacity:0.7;">

      <label for="apoioObs">Observa√ß√£o (Opcional)</label>
      <textarea id="apoioObs" placeholder="COMPLEMENTO..."></textarea>

      <div class="send-area">
        <button type="button" class="primary-btn" onclick="solicitarApoio()">Solicitar Apoio</button>
      </div>
    </form>
  </div>
</div>

<!-- VIEW RATT (REVEZAMENTO) -->
<div id="rattView" class="view view-scrollable hidden-right">
  <header>
    <button onclick="voltar('rattView')" class="theme-toggle"><i data-lucide="arrow-left"></i></button>
    <h1>Revezamento</h1>
    <div style="width:32px;"></div>
  </header>

  <div style="padding:20px;max-width:420px;margin:auto;">
    
    <!-- CONFIGURA√á√ÉO -->
    <div id="rattConfig" class="card">
      <div class="ratt-config">
        
        <div>
          <label>In√≠cio do Turno</label>
          <input type="time" id="rattInicio" value="07:00">
        </div>

        <div>
          <label>Fim do Turno</label>
          <input type="time" id="rattFim" value="13:00">
        </div>

        <div>
          <label>Tempo por Ciclo</label>
          <div id="tempoToggleGroup" class="ratt-toggle-group">
            <button type="button" class="ratt-toggle-btn" onclick="setTempoCiclo(20)">20 min</button>
            <button type="button" class="ratt-toggle-btn active" onclick="setTempoCiclo(30)">30 min</button>
            <button type="button" class="ratt-toggle-btn" onclick="setTempoCiclo(60)">60 min</button>
          </div>
        </div>

        <div>
          <label>Operadores por Vez</label>
          <div id="modoToggleGroup" class="ratt-toggle-group">
            <button type="button" class="ratt-toggle-btn" onclick="setModo(1)">1</button>
            <button type="button" class="ratt-toggle-btn active" onclick="setModo(2)">2</button>
            <button type="button" class="ratt-toggle-btn" onclick="setModo(3)">3</button>
          </div>
        </div>

        <div>
          <label>Equipe (separados por v√≠rgula)</label>
          <textarea id="rattEquipe" placeholder="MOURA, RAFAEL, CL√ÅUDIO, M√ÅRCIO, DANIEL" style="min-height:60px;"></textarea>
        </div>

      </div>

      <div class="send-area">
        <button type="button" class="primary-btn" onclick="iniciarRATT()" style="width:100%;">Iniciar Revezamento</button>
      </div>
    </div>

    <!-- DISPLAY ATIVO -->
    <div id="rattDisplay" class="card" style="display:none;margin-top:20px;">
      
      <!-- PROGRESSO DO TURNO -->
      <div class="turno-progress">
        <div class="turno-times">
          <span id="turnoInicio">07:00</span>
          <span id="turnoAtual">--:--</span>
          <span id="turnoFim">13:00</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="turnoProgressBar" style="width:0%;"></div>
        </div>
      </div>

      <!-- CRON√îMETRO CIRCULAR -->
      <div class="ratt-circular-timer">
        <svg class="timer-circle" viewBox="0 0 200 200">
          <circle class="timer-bg" cx="100" cy="100" r="90"></circle>
          <circle class="timer-progress" id="timerCircle" cx="100" cy="100" r="90"
                  stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
        </svg>
        <div class="timer-center">
          <div class="timer-display" id="rattTimer">00:00</div>
          <div class="timer-label">Tempo Restante</div>
        </div>
      </div>

      <!-- OPERADORES -->
      <div class="operators-grid" id="operatorsGrid"></div>

      <div class="ratt-controls">
        <button id="pausarRattBtn" type="button" class="ratt-btn ratt-btn-secondary" onclick="pausarRATT()">Pausar</button>
        <button type="button" class="ratt-btn ratt-btn-primary" onclick="revezarRATT()">Revezar</button>
      </div>

      <div class="send-area">
        <button type="button" class="ratt-btn ratt-btn-secondary" onclick="encerrarRATT()" style="width:100%;">Encerrar</button>
      </div>

    </div>

  </div>
</div>

<script>
lucide.createIcons();

/* === NAVEGA√á√ÉO === */
function abrir(id){
  const menu=document.getElementById('menuView');
  const tela=document.getElementById(id);
  
  // Carrega dados salvos do QRV ao abrir
  if(id==='qrvView'){
    carregarQRV();
  }
  
  if(id==='fotoView' || id==='apoioView'){
    const vtVal=vt.value.trim();
    const eqVal=equipe.value.trim();
    const qruVal=qru.value.trim();
    const qthVal=qth.value.trim();
    
    if(!vtVal||!eqVal||!qruVal||!qthVal){
      alert('Preencha o QRV primeiro');
      return;
    }
    
    const condutor=eqVal.split(',')[0].trim();
    
    if(id==='fotoView'){
      document.getElementById('fotoVt').value=vtVal;
      document.getElementById('fotoEquipe').value=eqVal;
      document.getElementById('fotoQru').value=qruVal;
      document.getElementById('fotoQth').value=qthVal;
    }else if(id==='apoioView'){
      document.getElementById('apoioVt').value=vtVal;
      document.getElementById('apoioCondutor').value=condutor;
      document.getElementById('apoioQth').value=qthVal;
      document.getElementById('apoioObs').value='';
    }
  }
  
  menu.classList.remove('active');menu.classList.add('hidden-left');
  tela.classList.remove('hidden-right');tela.classList.add('active');
  try{navigator.vibrate?.(40);}catch(e){}
}

function voltar(id){
  const menu=document.getElementById('menuView');
  const tela=document.getElementById(id);
  tela.classList.remove('active');tela.classList.add('hidden-right');
  menu.classList.remove('hidden-left');menu.classList.add('active');
  try{navigator.vibrate?.(30);}catch(e){}
}

/* === TEMA === */
const toggle=document.getElementById('themeToggle');
let dark=localStorage.getItem('theme')==='dark';
if(dark) document.body.classList.add('dark');
toggle.addEventListener('click',()=>{
  document.body.classList.toggle('dark');
  dark=document.body.classList.contains('dark');
  localStorage.setItem('theme',dark?'dark':'light');
  toggle.innerHTML=dark?'<i data-lucide="sun"></i>':'<i data-lucide="moon"></i>';
  lucide.createIcons();
});

/* === EMERG√äNCIA === */
const emergenciaBtn=document.getElementById('emergenciaBtn');
let longPress;
emergenciaBtn.addEventListener('touchstart',()=>{
  emergenciaBtn.style.transform='scale(0.95)';
  longPress=setTimeout(()=>window.location.href='tel:190',1200);
});
emergenciaBtn.addEventListener('touchend',()=>{
  clearTimeout(longPress);
  emergenciaBtn.style.transform='scale(1)';
});
function ligarCentral(){window.location.href='tel:+5585XXXXXXXX';}

/* === FORMUL√ÅRIO QRV === */
const vt=document.getElementById('vt');
const equipe=document.getElementById('equipe');
const qru=document.getElementById('qru');
const qth=document.getElementById('qth');
[vt,qth].forEach(f=>f.addEventListener('focus',()=>f.select()));
[equipe,qru,qth,vt].forEach(f=>f.addEventListener('input',()=>f.value=f.value.toUpperCase()));

function carregarQRV(){
  try{
    const dados=JSON.parse(localStorage.getItem('qrv_ultimo')||'null');
    if(dados){
      vt.value=dados.vt||'';
      equipe.value=dados.equipe||'';
      qru.value=dados.qru||'';
      qth.value=dados.qth||'';
    }
  }catch(e){
    console.error('Erro ao carregar QRV:',e);
  }
}

function salvarQRV(){
  const dados={
    vt:vt.value.trim(),
    equipe:equipe.value.trim(),
    qru:qru.value.trim(),
    qth:qth.value.trim(),
    timestamp:new Date().toISOString()
  };
  localStorage.setItem('qrv_ultimo',JSON.stringify(dados));
}

function limparQRV(){
  if(confirm('üóëÔ∏è Limpar todos os dados do QRV?')){
    vt.value='';
    equipe.value='';
    qru.value='';
    qth.value='';
    localStorage.removeItem('qrv_ultimo');
    try{navigator.vibrate?.(50);}catch(e){}
    vt.focus();
  }
}

function enviarQRV(){
  const vtVal=vt.value.trim(), eq=equipe.value.trim(), qruVal=qru.value.trim(), qthVal=qth.value.trim();
  if(!vtVal||!eq||!qruVal||!qthVal){
    alert('‚ùå Preencha todos os campos');
    return;
  }
  
  // Salva dados antes de enviar
  salvarQRV();
  
  const texto=`VT ${vtVal}\n${eq} (CONDUTOR)\nQRU: ${qruVal}\nQTH: ${qthVal}`;
  const encoded=encodeURIComponent(texto);
  window.location.href=`whatsapp://send?text=${encoded}`;
}

/* === FOTO === */
let fotoBlob=null;
function tirarFoto(){document.getElementById('inputFoto').click();}
document.getElementById('inputFoto').addEventListener('change',(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  fotoBlob=file;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    document.getElementById('previewFoto').src=ev.target.result;
    document.getElementById('previewContainer').style.display='block';
  };
  reader.readAsDataURL(file);
});

function resetarFoto(){
  fotoBlob=null;
  document.getElementById('inputFoto').value='';
  document.getElementById('previewFoto').src='';
  document.getElementById('previewContainer').style.display='none';
}
function enviarFoto(){
  if(!fotoBlob){alert('Tire uma foto primeiro');return;}
  const vtVal=document.getElementById('fotoVt').value;
  const eqVal=document.getElementById('fotoEquipe').value;
  const qruVal=document.getElementById('fotoQru').value;
  const qthVal=document.getElementById('fotoQth').value;
  const msg=`üì∏ REGISTRO FOTOGR√ÅFICO\n\nVT ${vtVal}\n${eqVal}\nQRU: ${qruVal}\nQTH: ${qthVal}`;
  if(navigator.share){
    const fotoFile=new File([fotoBlob],'registro.jpg',{type:'image/jpeg'});
    navigator.share({title:'Registro Operacional',text:msg,files:[fotoFile]})
    .then(()=>{resetarFoto();voltar('fotoView');})
    .catch(err=>console.log('Compartilhamento cancelado'));
  }else{
    alert('Foto capturada!\n\nPara enviar:\n1. Abra o WhatsApp\n2. Cole a mensagem\n3. Anexe a foto manualmente');
    navigator.clipboard.writeText(msg);
    resetarFoto();
  }
}

/* === APOIO === */
function solicitarApoio(){
  const vtVal=document.getElementById('apoioVt').value;
  const condutor=document.getElementById('apoioCondutor').value;
  const qthVal=document.getElementById('apoioQth').value;
  const obs=document.getElementById('apoioObs').value.trim();
  let msg=`Viatura equipe: ${condutor} VT: ${vtVal} solicita apoio em QTH: ${qthVal}`;
  if(obs) msg+=`\nObserva√ß√£o: ${obs}`;
  const encoded=encodeURIComponent(msg);
  window.location.href=`whatsapp://send?text=${encoded}`;
  document.getElementById('apoioObs').value='';
}

/* === RATT (REVEZAMENTO MELHORADO) === */
let rattState={
  tempoCiclo:30,
  modo:2,
  equipe:[],
  cicloAtual:0,
  grupos:[],
  iniciado:false,
  pausado:false,
  tempoRestante:0,
  tempoTotal:0,
  intervalId:null,
  clockId:null,
  historico:[],
  turnoInicio:null,
  turnoFim:null
};

function setTempoCiclo(minutos){
  rattState.tempoCiclo = minutos;
  const tempoBotoes = document.querySelectorAll('#tempoToggleGroup .ratt-toggle-btn');
  const valores = [20, 30, 60];
  
  tempoBotoes.forEach((btn, i) => {
    btn.classList.toggle('active', valores[i] === minutos);
  });
}

function setModo(operadores){
  rattState.modo = operadores;
  const modoBotoes = document.querySelectorAll('#modoToggleGroup .ratt-toggle-btn');
  
  modoBotoes.forEach((btn, i) => {
    const valorBotao = i + 1;
    btn.classList.toggle('active', valorBotao === operadores);
  });
}

function iniciarRATT(){
  const inicio=document.getElementById('rattInicio').value;
  const fim=document.getElementById('rattFim').value;
  const equipeTexto=document.getElementById('rattEquipe').value.trim();
  
  if(!inicio||!fim){alert('Defina in√≠cio e fim do turno');return;}
  if(!equipeTexto){alert('Informe a equipe');return;}
  
  rattState.equipe=equipeTexto.split(',').map(n=>n.trim().toUpperCase()).filter(n=>n);
  if(rattState.equipe.length < rattState.modo){
    alert(`√â necess√°rio ter pelo menos ${rattState.modo} operadores na equipe.`);
    return;
  }
  
  rattState.turnoInicio=inicio;
  rattState.turnoFim=fim;
  rattState.grupos=gerarGrupos(rattState.equipe,rattState.modo);
  rattState.cicloAtual=0;
  rattState.tempoRestante=rattState.tempoCiclo*60;
  rattState.tempoTotal=rattState.tempoCiclo*60;
  rattState.iniciado=true;
  rattState.pausado=false;
  
  document.getElementById('turnoInicio').textContent=inicio;
  document.getElementById('turnoFim').textContent=fim;
  document.getElementById('rattConfig').style.display='none';
  document.getElementById('rattDisplay').style.display='block';
  
  renderizarOperadores();
  atualizarDisplayRATT();
  iniciarTimers();
}

function gerarGrupos(equipe,tamanho){
  const grupos=[];
  for(let i = 0; i < equipe.length; i++){
    const grupo = [];
    for(let j = 0; j < tamanho; j++){
      grupo.push(equipe[(i + j) % equipe.length]);
    }
    grupos.push(grupo);
  }
  return grupos;
}

function renderizarOperadores(){
  const container=document.getElementById('operatorsGrid');
  container.innerHTML='';
  
  rattState.equipe.forEach((op,idx)=>{
    const card=document.createElement('div');
    card.className='operator-card';
    card.id=`op-${idx}`;
    
    const inicial=op.charAt(0);
    card.innerHTML=`
      <div class="operator-icon">${inicial}</div>
      <div class="operator-info">
        <div class="operator-name">${op}</div>
        <div class="operator-status">Aguardando...</div>
      </div>
    `;
    
    container.appendChild(card);
  });
}

function atualizarDisplayRATT(){
  if (rattState.grupos.length === 0) return;
  
  const grupoAtual=rattState.grupos[rattState.cicloAtual % rattState.grupos.length];
  
  // Atualiza cards dos operadores
  rattState.equipe.forEach((op,idx)=>{
    const card=document.getElementById(`op-${idx}`);
    const status=card.querySelector('.operator-status');
    
    if(grupoAtual.includes(op)){
      card.classList.add('active');
      status.textContent='Em Campo';
    }else{
      card.classList.remove('active');
      const posProximo=rattState.grupos.findIndex(g=>g.includes(op) && rattState.grupos.indexOf(g) > rattState.cicloAtual);
      if(posProximo === (rattState.cicloAtual + 1) % rattState.grupos.length){
        status.textContent='Pr√≥ximo';
      }else{
        status.textContent='Descansando';
      }
    }
  });
  
  atualizarTimer();
  atualizarProgressoTurno();
}

function iniciarTimers(){
  if(rattState.clockId) clearInterval(rattState.clockId);
  if(rattState.intervalId) clearInterval(rattState.intervalId);
  
  rattState.clockId=setInterval(()=>{
    atualizarProgressoTurno();
  },1000);
  
  rattState.intervalId=setInterval(()=>{
    if(!rattState.pausado && rattState.tempoRestante>0){
      rattState.tempoRestante--;
      atualizarTimer();
      if(rattState.tempoRestante===0){
        alertaRevezamento();
      }
    }
  },1000);
}

function atualizarTimer(){
  const m=Math.floor(rattState.tempoRestante/60);
  const s=rattState.tempoRestante%60;
  document.getElementById('rattTimer').textContent=
    `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  
  // Atualiza c√≠rculo
  const progresso = (rattState.tempoRestante / rattState.tempoTotal) * 565.48;
  document.getElementById('timerCircle').style.strokeDashoffset = 565.48 - progresso;
}

function atualizarProgressoTurno(){
  const agora=new Date();
  const horaAtual=agora.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('turnoAtual').textContent=horaAtual;
  
  // Calcula progresso do turno
  const [hInicio,mInicio]=rattState.turnoInicio.split(':').map(Number);
  const [hFim,mFim]=rattState.turnoFim.split(':').map(Number);
  const [hAtual,mAtual]=[agora.getHours(),agora.getMinutes()];
  
  const minInicio=hInicio*60+mInicio;
  const minFim=hFim*60+mFim;
  const minAtual=hAtual*60+mAtual;
  
  let progresso=0;
  if(minAtual>=minInicio && minAtual<=minFim){
    progresso=((minAtual-minInicio)/(minFim-minInicio))*100;
  }else if(minAtual>minFim){
    progresso=100;
  }
  
  document.getElementById('turnoProgressBar').style.width=`${progresso}%`;
}

function alertaRevezamento(){
  try{navigator.vibrate?.([500, 100, 500]);}catch(e){}
  if(confirm('‚è∞ Tempo esgotado! Revezar agora?')){
    revezarRATT();
  }else{
    // Se n√£o revezar, reseta timer mas mant√©m grupo
    rattState.tempoRestante=rattState.tempoCiclo*60;
  }
}

function revezarRATT(){
  rattState.historico.push({
    ciclo:rattState.cicloAtual,
    grupo:rattState.grupos[rattState.cicloAtual % rattState.grupos.length],
    hora:new Date().toLocaleTimeString('pt-BR')
  });
  rattState.cicloAtual++;
  rattState.tempoRestante=rattState.tempoCiclo*60;
  atualizarDisplayRATT();
  try{navigator.vibrate?.(100);}catch(e){}
}

function pausarRATT(){
  rattState.pausado=!rattState.pausado;
  const btn=document.getElementById('pausarRattBtn');
  btn.textContent=rattState.pausado?'Retomar':'Pausar';
  
  // Feedback visual
  const timer=document.getElementById('rattTimer');
  if(rattState.pausado){
    timer.style.opacity='0.5';
  }else{
    timer.style.opacity='1';
  }
}

function encerrarRATT(){
  if(confirm('üõë Encerrar revezamento? O hist√≥rico ser√° salvo.')){
    clearInterval(rattState.intervalId);
    clearInterval(rattState.clockId);
    rattState.iniciado=false;
    document.getElementById('rattConfig').style.display='block';
    document.getElementById('rattDisplay').style.display='none';
    salvarHistoricoRATT();
  }
}

function salvarHistoricoRATT(){
  const data=new Date().toISOString().split('T')[0];
  const hist=JSON.parse(localStorage.getItem('ratt_historico')||'[]');
  hist.push({
    data:data,
    turno:`${rattState.turnoInicio}-${rattState.turnoFim}`,
    ciclos:rattState.historico,
    equipe:rattState.equipe,
    modo:rattState.modo,
    tempoCiclo:rattState.tempoCiclo
  });
  localStorage.setItem('ratt_historico',JSON.stringify(hist.slice(-7)));
  rattState.historico = [];
}

/* === QTA (Encerrar Ciclo QRV) === */

// adiciona o bot√£o QTA no formul√°rio QRV ap√≥s carregamento
document.addEventListener('DOMContentLoaded', () => {
  const qrvForm = document.getElementById('qrvForm');
  if (!document.getElementById('qtaBtn')) {
    const qtaBtn = document.createElement('button');
    qtaBtn.id = 'qtaBtn';
    qtaBtn.type = 'button';
    qtaBtn.className = 'primary-btn';
    qtaBtn.style.background = 'linear-gradient(145deg, #dc2626, #b91c1c)';
    qtaBtn.style.marginTop = '10px';
    qtaBtn.textContent = 'Encerrar Ciclo (QTA)';
    qtaBtn.onclick = encerrarQTA;
    qrvForm.querySelector('.send-area').appendChild(qtaBtn);
  }
});

// estado de bloqueio do QRV
let qrvBloqueado = false;

// fun√ß√£o de encerramento de ciclo
function encerrarQTA() {
  if (qrvBloqueado) {
    alert('‚ö†Ô∏è O ciclo j√° est√° encerrado.\nAguarde uma nova QRU para iniciar um novo QRV.');
    return;
  }

  const confirmar = confirm('üõë Confirmar encerramento do ciclo (QTA)?');
  if (!confirmar) return;

  const dados = {
    vt: vt.value.trim(),
    equipe: equipe.value.trim(),
    qru: qru.value.trim(),
    qth: qth.value.trim(),
    encerradoEm: new Date().toLocaleString('pt-BR'),
  };

  // valida dados m√≠nimos
  if (!dados.vt || !dados.equipe) {
    alert('‚ùå Complete os campos de VT e Equipe antes de encerrar.');
    return;
  }

  // salva registro local do QTA
  const historico = JSON.parse(localStorage.getItem('qta_historico') || '[]');
  historico.push(dados);
  localStorage.setItem('qta_historico', JSON.stringify(historico.slice(-10))); // mant√©m √∫ltimos 10

  // bloqueia QRV at√© nova QRU
  qrvBloqueado = true;
  localStorage.setItem('qrv_bloqueado', 'true');

  // limpa QRU (aguardando nova miss√£o)
  qru.value = '';
  salvarQRV();

  alert(`‚úÖ Ciclo encerrado (QTA registrado).\n\nVT ${dados.vt}\nEquipe: ${dados.equipe}\nQTH: ${dados.qth}`);

  // notifica RATT se ativo
  try {
    espelharQTAnoRATT(dados);
  } catch (e) {
    console.warn('RATT n√£o ativo para espelhar QTA.');
  }

  try { navigator.vibrate?.([80, 40, 80]); } catch(e){}
}

// desbloqueia QRV quando uma nova QRU √© informada
qru.addEventListener('input', () => {
  if (qru.value.trim() && qrvBloqueado) {
    qrvBloqueado = false;
    localStorage.removeItem('qrv_bloqueado');
    console.log('üîì Novo ciclo QRV liberado.');
  }
});

// impede envio se estiver bloqueado
const oldEnviarQRV = enviarQRV;
enviarQRV = function () {
  if (localStorage.getItem('qrv_bloqueado') === 'true') {
    alert('‚ö†Ô∏è O ciclo anterior ainda est√° encerrado (QTA ativo).\nInforme uma nova QRU para iniciar.');
    return;
  }
  oldEnviarQRV();
};

// sincroniza status ao abrir o QRV
function carregarEstadoQTA() {
  qrvBloqueado = localStorage.getItem('qrv_bloqueado') === 'true';
  if (qrvBloqueado) {
    console.log('üîí QRV bloqueado at√© nova QRU.');
  }
}
carregarEstadoQTA();

/* === ESPELHAR QTA NO REVEZAMENTO (RATT) === */
function espelharQTAnoRATT(dadosQTA) {
  // se o RATT estiver ativo
  if (rattState && rattState.iniciado) {
    const msg = `üü£ QTA recebido ‚Äî Ciclo encerrado\nVT ${dadosQTA.vt}\n${dadosQTA.equipe}\nQTH: ${dadosQTA.qth}\n${dadosQTA.encerradoEm}`;
    console.log(msg);

    // insere registro no hist√≥rico do RATT atual
    rattState.historico.push({
      ciclo: rattState.cicloAtual,
      tipo: 'QTA',
      dados: dadosQTA,
    });

    // opcional: alerta visual leve
    alert('üì° RATT notificado: QTA recebido.');
  }
}

</script>
</body>
</html>